name: Web Tests CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * 1' # Segunda-feira Ã s 9h UTC

jobs:
  test:
    name: Run Web Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: ['11', '17']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Install Chrome (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Run tests (Headless)
        run: ./gradlew clean test -Dheadless=true --info
        continue-on-error: false

      - name: Generate Allure Report
        if: always()
        run: ./gradlew allureReport

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-java${{ matrix.java }}
          path: |
            build/reports/
            build/test-results/
            build/screenshots/

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.os }}-java${{ matrix.java }}
          path: build/allure-results

      - name: Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results - ${{ matrix.os }} - Java ${{ matrix.java }}
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: true

  publish-report:
    name: Publish Allure Report
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge Allure results
        run: |
          mkdir -p allure-results
          find artifacts -name "allure-results*" -type d -exec cp -r {}/* allure-results/ \;

      - name: Generate and deploy Allure Report
        uses: simple-elf/allure-report-action@v1.7
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history
          keep_reports: 20